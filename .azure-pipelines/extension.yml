variables:
  projectDir: extension

trigger:
  paths:
    include:
    - extension/*
    - .azure-pipelines/extension.yml
pr:
  paths:
    include:
    - extension/*
    - .azure-pipelines/extension.yml

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UseNode@1
  inputs:
    version: '12.x'
- bash: npm install
  name: InstallDeps
  workingDirectory: ${{variables.projectDir}}
- bash: npm run build
  name: Build
  workingDirectory: ${{variables.projectDir}}
- bash: npm run test
  name: Test
  workingDirectory: ${{variables.projectDir}}
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '${{variables.projectDir}}/junit.xml'
    testRunTitle: 'aws-widget-function-$(Build.BuildNumber)'
- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '${{variables.projectDir}}/coverage/cobertura-coverage.xml'
- task: SonarCloudPrepare@1
  inputs:
    SonarCloud: 'SonarCloud Swellaby'
    organization: 'swellaby'
    scannerMode: 'CLI'
    configMode: 'file'
    configFile: '${{variables.projectDir}}/sonar-project.properties'
- task: SonarCloudAnalyze@1
- task: SonarCloudPublish@1
  inputs:
    pollingTimeoutSec: '300'
